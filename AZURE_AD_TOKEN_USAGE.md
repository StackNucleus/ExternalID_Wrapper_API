# Azure AD Token Generation Endpoints

This document explains how to use the new Azure AD token generation endpoints that allow you to generate Azure AD tokens for use with both `GraphController` and `CustomGraphController`.

## New Endpoints Added

### 1. Generate Azure AD Token (Client Credentials)
**Endpoint**: `POST /Token/azure-ad`

**Description**: Generates an Azure AD token using client credentials flow. This token can be used for both GraphController and CustomGraphController.

**Request Body**:
```json
{
  "client_id": "your-client-id",
  "client_secret": "your-client-secret",
  "scope": "https://graph.microsoft.com/.default"
}
```

**Response**:
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "https://graph.microsoft.com/.default"
}
```

### 2. Generate Azure AD Token (Alternative Client Credentials)
**Endpoint**: `POST /Token/azure-ad/client-credentials`

**Description**: Alternative endpoint for generating Azure AD tokens using client credentials flow. This token can be used for both GraphController and CustomGraphController.

**Request Body**:
```json
{
  "client_id": "your-client-id",
  "client_secret": "your-client-secret",
  "scope": "https://graph.microsoft.com/.default"
}
```

**Response**:
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "https://graph.microsoft.com/.default"
}
```

## Usage Examples

### Using Postman

#### Method 1: Client Credentials Flow (Primary)
1. **Generate Azure AD Token**:
   ```http
   POST https://localhost:7110/Token/azure-ad
   Content-Type: application/json
   
   {
     "client_id": "your-client-id",
     "client_secret": "your-client-secret",
     "scope": "https://graph.microsoft.com/.default"
   }
   ```

2. **Use the Token**:
   ```http
   GET https://localhost:7110/Graph/getUserById?idOrEmail=user@example.com
   Authorization: Bearer <azure-ad-token-from-step-1>
   ```

#### Method 2: Alternative Client Credentials Flow
1. **Generate Azure AD Token**:
   ```http
   POST https://localhost:7110/Token/azure-ad/client-credentials
   Content-Type: application/json
   
   {
     "client_id": "your-client-id",
     "client_secret": "your-client-secret",
     "scope": "https://graph.microsoft.com/.default"
   }
   ```

2. **Use the Token**:
   ```http
   GET https://localhost:7110/CustomGraph/getUserById?idOrEmail=user@example.com
   Authorization: Bearer <azure-ad-token-from-step-1>
   ```

### Using cURL

#### Client Credentials Flow (Primary)
```bash
# Generate token
curl -X POST "https://localhost:7110/Token/azure-ad" \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "your-client-id",
    "client_secret": "your-client-secret",
    "scope": "https://graph.microsoft.com/.default"
  }'

# Use token
curl -X GET "https://localhost:7110/Graph/getUserById?idOrEmail=user@example.com" \
  -H "Authorization: Bearer <token-from-above>"
```

#### Alternative Client Credentials Flow
```bash
# Generate token
curl -X POST "https://localhost:7110/Token/azure-ad/client-credentials" \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "your-client-id",
    "client_secret": "your-client-secret",
    "scope": "https://graph.microsoft.com/.default"
  }'

# Use token
curl -X GET "https://localhost:7110/CustomGraph/getUserById?idOrEmail=user@example.com" \
  -H "Authorization: Bearer <token-from-above>"
```

## Token Compatibility

| Token Type | GraphController | CustomGraphController | Notes |
|------------|-----------------|----------------------|-------|
| Custom JWT (from `/Token`) | ✅ | ✅ | Generated by the API |
| Azure AD Token (from `/Token/azure-ad`) | ✅ | ✅ | Client credentials flow |
| Azure AD Token (from `/Token/azure-ad/client-credentials`) | ✅ | ✅ | Alternative client credentials flow |

### CustomGraphController Endpoints Supporting All Token Types

The following CustomGraphController endpoints now accept tokens from all three sources:

- ✅ `getUserByEmail` - Get user by email address
- ✅ `updateUserByEmail` - Update user by email address  
- ✅ `updateUserAttributesByEmail` - Update specific user attributes by email
- ✅ `deleteUserByEmail` - Delete user by email address
- ✅ `resetPasswordByEmail` - Reset user password by email address
- ✅ `getUserById` - Get user by ID or email
- ✅ `updateUserById` - Update user by ID or email
- ✅ `updateUserAttributesById` - Update specific user attributes by ID
- ✅ `deleteUserById` - Delete user by ID or email
- ✅ `resetPasswordById` - Reset user password by ID or email
- ✅ `changePassword` - Change user password
- ✅ `getAllUsers` - Get all users (with pagination)

## How Token Handling Works

### CustomGraphController Token Processing

1. **Azure AD Tokens** (from `/Token/azure-ad` or `/Token/azure-ad/client-credentials`):
   - Detected automatically by token characteristics
   - Used directly with Microsoft Graph API
   - No additional processing required

2. **Custom JWT Tokens** (from `/Token`):
   - Detected as non-Azure AD tokens
   - Exchanged for Azure AD tokens using client credentials flow
   - Uses configured Azure AD app credentials for the exchange

3. **Token Validation**:
   - All tokens are validated before use
   - Proper error handling for invalid or expired tokens
   - Detailed logging for troubleshooting

## Benefits

1. **Unified Token System**: Both controllers now accept Azure AD tokens
2. **Better Security**: Azure AD tokens have built-in security features
3. **Standard Compliance**: Uses standard OAuth 2.0 flows
4. **Flexibility**: Support for both user and service authentication
5. **Microsoft Graph Integration**: Direct compatibility with Microsoft Graph API
6. **Backward Compatibility**: Custom JWT tokens still work via automatic exchange

## Configuration Requirements

### For Token Generation Endpoints
Make sure your `appsettings.json` contains the Azure AD tenant configuration:

```json
{
  "AzureAd": {
    "TenantId": "yourdomain.onmicrosoft.com"
  }
}
```

**Note**: The `client_id` and `client_secret` are provided by the user in the request body, so they don't need to be configured in the application settings.

### For CustomGraphController Endpoints
For CustomGraphController endpoints to work with custom JWT tokens, you also need:

```json
{
  "AzureAd": {
    "TenantId": "yourdomain.onmicrosoft.com",
    "ClientId": "your-azure-ad-client-id",
    "ClientSecret": "your-azure-ad-client-secret"
  }
}
```

**Note**: CustomGraphController uses these credentials to exchange custom JWT tokens for Azure AD tokens when needed.

## Error Handling

The endpoints return standard OAuth 2.0 error responses:

```json
{
  "error": "invalid_grant",
  "error_description": "AADSTS50126: Error validating credentials due to invalid username or password.",
  "error_codes": [50126],
  "timestamp": "2024-01-01T00:00:00.0000000Z",
  "trace_id": "12345678-1234-1234-1234-123456789012",
  "correlation_id": "12345678-1234-1234-1234-123456789012"
}
```

## Security Notes

1. **Client Credentials Flow**: Secure for service-to-service scenarios
2. **User Input Validation**: Always validate client_id and client_secret
3. **Token Storage**: Never store tokens in plain text
4. **Token Expiration**: Tokens expire after 1 hour by default
5. **Scope Limitation**: Request only the scopes you need
6. **Credential Security**: Keep client_secret secure and never expose it in client-side code

## Troubleshooting

### "The signature key was not found" Error

If you encounter this error when using Azure AD tokens:

```
401 Unauthorized
Error: response status is 401
www-authenticate: Bearer error="invalid_token",error_description="The signature key was not found"
```

**Solution**: The API has been updated to handle both custom JWT tokens and Azure AD tokens automatically. The authentication middleware now:

1. **Detects Azure AD tokens** by checking the issuer claim
2. **Validates custom JWT tokens** using the configured JWT secret
3. **Accepts Azure AD tokens** without signature validation (since they're validated by Azure AD)

**How it works**:
- Custom JWT tokens are validated using your API's JWT secret
- Azure AD tokens are accepted based on their issuer claim
- Both token types work seamlessly with all endpoints

### Token Type Detection

The API automatically detects token types:

- **Azure AD Tokens**: Issuer contains `login.microsoftonline.com` or `sts.windows.net`
- **Custom JWT Tokens**: All other tokens validated with your JWT secret

### Testing Token Types

You can test with any of these token sources:

```bash
# 1. Custom JWT token
curl -X GET "https://localhost:7110/CustomGraph/getUserByEmail?email=user@example.com" \
  -H "Authorization: Bearer <custom-jwt-token>"

# 2. Azure AD token from /Token/azure-ad
curl -X GET "https://localhost:7110/CustomGraph/getUserByEmail?email=user@example.com" \
  -H "Authorization: Bearer <azure-ad-token>"

# 3. Azure AD token from /Token/azure-ad/client-credentials
curl -X GET "https://localhost:7110/CustomGraph/getUserByEmail?email=user@example.com" \
  -H "Authorization: Bearer <azure-ad-token>"
```

All three should work without the signature key error. 